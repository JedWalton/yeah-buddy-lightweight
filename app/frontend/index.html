<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello World with Go and HTMX</title>
    <script src="https://unpkg.com/htmx.org"></script>
</head>
<body>
<h1>Hello, World from HTML!</h1>
<div hx-get="/htmx/public/htmx" hx-trigger="load">
    Loading...
</div>
<h1>Hello, World Except It's protected from HTML!</h1>
<div hx-get="/htmx/protected/htmx" hx-trigger="load">
    Loading...
</div>

<div id="register">
    <h2>Register</h2>
    <form id="registerForm">
        <input type="text" name="username" placeholder="Username" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Register</button>
    </form>
    <!-- Placeholder for displaying registration messages -->
    <div id="registrationMessage"></div>
</div>
<script>
    document.getElementById('registerForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        const form = event.target;
        const formData = new FormData(form);
        const jsonData = Object.fromEntries(formData.entries());

        fetch('/auth/public/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // Set Content-Type to application/json
                'Accept': 'application/json', // Ensure we're accepting JSON in response
            },
            body: JSON.stringify(jsonData), // Convert the form data to JSON
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                // Handle error, show message to the user
                document.getElementById('registrationMessage').innerText = data.error;
            } else {
                // Handle success, clear form, show success message, or redirect
                form.reset();
                document.getElementById('registrationMessage').innerText = 'Registration successful!';
                // Optionally redirect the user or update UI
            }
        })
        .catch(error => {
            // Handle any errors that occurred during fetch
            console.error('Error:', error);
            document.getElementById('registrationMessage').innerText = 'An error occurred during registration.';
        });
    });
</script>

<div id="login">
    <h2>Login</h2>
    <form id="loginForm">
        <input type="text" name="username" placeholder="Username" required>
        <input type="password" name="password" placeholder="Password" required>
        <button type="submit">Login</button>
    </form>
    <!-- Placeholder for login messages -->
    <div id="loginMessage"></div>
</div>
<script>
    document.getElementById('loginForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent the default form submission

        const form = event.target;
        const formData = new FormData(form);
        const jsonData = Object.fromEntries(formData.entries());

        fetch('/auth/public/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // Set Content-Type to application/json
                'Accept': 'application/json', // Accept JSON responses
            },
            body: JSON.stringify(jsonData), // Convert the form data to JSON
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Login failed with status: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.token) {
                localStorage.setItem('jwtToken', data.token);
                document.getElementById('loginMessage').innerText = 'Login successful!';
                // Optionally, redirect the user or update UI to reflect the logged-in state
                // For example:
                // window.location.href = '/dashboard';
            } else {
                // Handle login failure
                document.getElementById('loginMessage').innerText = data.error || 'Login failed';
            }
        })
        .catch(error => {
            // Handle any errors that occurred during fetch or if response was not ok
            console.error('Error:', error);
            document.getElementById('loginMessage').innerText = error.toString();
        });
    });
</script>



<button hx-get="/auth/protected/account-info" hx-trigger="click" hx-target="#accountInfo" hx-swap="innerHTML">
    Load Account Info
</button>
<div id="accountInfo">
    <!-- Account info will be loaded here -->
</div>
<script>
    document.body.addEventListener('htmx:configRequest', function (event) {
        const jwtToken = localStorage.getItem('jwtToken');
        if (jwtToken) {
            // Add the JWT as an Authorization header
            event.detail.headers['Authorization'] = 'Bearer ' + jwtToken;
        }
    });
</script>


</body>
</html>
