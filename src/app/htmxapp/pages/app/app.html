<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynamic Graph with D3.js and HTMX</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/htmx.org"></script>
    <script src="https://unpkg.com/tailwindcss-jit-cdn"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>

<!-- Snippet -->
<section class="flex flex-col justify-center antialiased bg-gray-100 text-gray-600 min-h-screen">
    <div class="max-w-3xl mx-auto p-4 sm:px-6 h-full">
        <!-- Chart widget -->
        <div class="flex flex-col col-span-full xl:col-span-8 bg-white shadow-lg rounded-sm border border-gray-200">
            <header class="px-5 py-4 border-b border-gray-100 flex items-center">
                <h2 class="font-semibold text-gray-800">Analytics</h2>
            </header>
            <div class="px-5 py-1">
                <div class="flex flex-wrap">
                    <!-- Unique Visitors -->
                    <div class="flex items-center py-2">
                        <div class="mr-5">
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-gray-800 mr-2">24.7K</div>
                                <div class="text-sm font-medium text-green-500">+49%</div>
                            </div>
                            <div class="text-sm text-gray-500">Unique Visitors</div>
                        </div>
                        <div class="hidden md:block w-px h-8 bg-gray-200 mr-5" aria-hidden="true"></div>
                    </div>
                    <!-- Total Pageviews -->
                    <div class="flex items-center py-2">
                        <div class="mr-5">
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-gray-800 mr-2">56.9K</div>
                                <div class="text-sm font-medium text-green-500">+7%</div>
                            </div>
                            <div class="text-sm text-gray-500">Total Pageviews</div>
                        </div>
                        <div class="hidden md:block w-px h-8 bg-gray-200 mr-5" aria-hidden="true"></div>
                    </div>
                    <!-- Bounce Rate -->
                    <div class="flex items-center py-2">
                        <div class="mr-5">
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-gray-800 mr-2">54%</div>
                                <div class="text-sm font-medium text-yellow-500">-7%</div>
                            </div>
                            <div class="text-sm text-gray-500">Bounce Rate</div>
                        </div>
                        <div class="hidden md:block w-px h-8 bg-gray-200 mr-5" aria-hidden="true"></div>
                    </div>
                    <!-- Visit Duration-->
                    <div class="flex items-center">
                        <div>
                            <div class="flex items-center">
                                <div class="text-3xl font-bold text-gray-800 mr-2">2m 56s</div>
                                <div class="text-sm font-medium text-yellow-500">+7%</div>
                            </div>
                            <div class="text-sm text-gray-500">Visit Duration</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="graph-container">
                <svg width="600" height="400"></svg>
                <button hx-get="/app/graph-data" hx-trigger="every 0.5s" hx-swap="none" hx-target="#graph-container">Update Graph</button>
            </div>
            <script>
                const svg = d3.select("svg"),
                    margin = {top: 20, right: 20, bottom: 30, left: 40},
                    width = +svg.attr("width") - margin.left - margin.right,
                    height = +svg.attr("height") - margin.top - margin.bottom;

                const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                // Set up scales with increased padding for more whitespace
                const xScale = d3.scaleBand().range([0, width]).padding(0.2); // Increase padding here
                const yScale = d3.scaleLinear().range([height, 0]);

                // Set up axes
                const xAxis = g.append("g")
                    .attr("class", "x-axis")
                    .attr("transform", `translate(0,${height})`);

                const yAxis = g.append("g")
                    .attr("class", "y-axis");

                let data = [];

                document.body.addEventListener('htmx:beforeRequest', function(event) {
                    // Get the next data point on each HTMX AJAX request
                    fetch('/app/graph-data')
                        .then(response => response.json())
                        .then(newData => {
                            // Add new data point
                            data.push({
                                timestamp: new Date().toISOString(), // Generate a timestamp or use server-side timestamp
                                value: newData.value
                            });

                            // Keep the last 10 data points
                            if (data.length > 100) {
                                data.shift(); // Remove the oldest data point
                            }

                            updateGraph();
                        });
                });

                function updateGraph() {
                    // Update scales
                    if (xScale.setDomain) {
                        xScale.setDomain(data.map(d => d.timestamp));
                    } else {
                        xScale.domain(data.map(d => d.timestamp));
                    }

                    if (yScale.setDomain) {
                        yScale.setDomain([0, d3.max(data, d => d.value)]);
                    } else {
                        yScale.domain([0, d3.max(data, d => d.value)]);
                    }

                    // Redraw axis
                    xAxis.transition().call(d3.axisBottom(xScale))
                        .selectAll("text")
                        .attr("transform", "rotate(-45)")
                        .style("text-anchor", "end");

                    yAxis.transition().call(d3.axisLeft(yScale));

                    // Bind data to bars
                    const bars = g.selectAll(".bar")
                        .data(data, d => d.timestamp);

                    // Enter new bars
                    bars.enter().append("rect")
                        .attr("class", "bar")
                        .attr("x", d => xScale(d.timestamp))
                        .attr("width", xScale.bandwidth())
                        .attr("fill", "#10B981") // TailwindCSS green-500, change as needed
                        .merge(bars) // Merge enter and update selections
                        .transition()
                        .attr("y", d => yScale(d.value))
                        .attr("height", d => height - yScale(d.value))
                        .attr("fill", "#10B981"); // Ensure existing bars also turn green

                    // Exit old bars
                    bars.exit().remove();
                }
            </script>
<!--            <div class="flex-grow">-->
<!--                <canvas id="analytics-card-01" width="800" height="300"></canvas>-->
<!--            </div>-->
        </div>
    </div>
</section>

<!-- More components -->
<div x-show="open" class="fixed bottom-0 right-0 w-full md:bottom-8 md:right-12 md:w-auto z-60" x-data="{ open: true }">
    <div class="bg-gray-800 text-gray-50 text-sm p-3 md:rounded shadow-lg flex justify-between">
        <div>ðŸ‘‰ <a class="hover:underline ml-1" href="/" target="_blank">Powered by PingDuty</a></div>
        <button class="text-gray-500 hover:text-gray-400 ml-5" @click="open = false">
            <span class="sr-only" >Close</span>
            <svg class="w-4 h-4 flex-shrink-0 fill-current" viewBox="0 0 16 16">
                <path d="M12.72 3.293a1 1 0 00-1.415 0L8.012 6.586 4.72 3.293a1 1 0 00-1.414 1.414L6.598 8l-3.293 3.293a1 1 0 101.414 1.414l3.293-3.293 3.293 3.293a1 1 0 001.414-1.414L9.426 8l3.293-3.293a1 1 0 000-1.414z" />
            </svg>
        </button>
    </div>
</div>
</body>
</html>
